from requests_oauthlib import OAuth2Session
from oauthlib.oauth2 import BackendApplicationClient
import datetime
import json

now = datetime.datetime.now()
format_date = now.strftime("%Y-%m-%dT%H:%M:%SZ")

CLIENT_ID = "mwb-cloud-#####" # Your MalwareBytes Client ID in the form of mwb-cloud-*******
CLIENT_SECRET = "#####" # Your MalwareBytes Client Secret (Looks like a SHA-256 hash)
CLIENT_ACCOUNT = "########-####-####-####-############" # Your MalwareBytes Client Account 

def NEBULA_URL(path):
    return "{NEBULA_URL}{PATH}".format(NEBULA_URL="https://api.malwarebytes.com", PATH=path)

def get_nebula_client(client_id, client_secret, account_id):
    client_scope = ["read"]
    headers = {"accountid": account_id}

    client = BackendApplicationClient(client_id, scope=client_scope)
    nebula = OAuth2Session(client=client, scope=client_scope)
    nebula.headers.update(headers)
    token = nebula.fetch_token(
        token_url=NEBULA_URL('/oauth2/token'),
        client_secret=client_secret, scope=" ".join(client_scope))
    return nebula

resp = get_nebula_client(CLIENT_ID, CLIENT_SECRET, CLIENT_ACCOUNT).get(NEBULA_URL('/nebula/v1/events'))

events = resp.json()
events = events['events']
for message in events:   
    with open('/Users/<user>/Documents/scripts/python/malwarebytes/malwarebytes-' + now.strftime("%Y-%m-%dT%H-%M-%SZ") + '.json', 'a') as outfile: # User is your Win MacOS X User Location
        json.dump(message, outfile)
        outfile.write('\n')